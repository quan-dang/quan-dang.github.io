<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="" />
  <meta name="description" content="" />
  
  
  <title>
    
      Model Serving sử dụng BentoML 
      
      
      |
    
     MLE Blog
  </title>

  
    <link rel="apple-touch-icon" href="/images/ml-favicon.png">
    <link rel="icon" href="/images/ml-favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

<meta name="generator" content="Hexo 5.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/pipi.jpeg" alt="">
      
    </a>
    <div class="nickname"><a href="/">Quan Dang</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">Model Serving sử dụng BentoML</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2021-10-30 10:09:30
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="Tags"></i>
                
                <span class="span--tag">
                  <a href="/tags/model-serving/" title="model serving">
                    <b>#</b> model serving
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <div style="text-align: center"> Khi mà một model đã được train xong và đáp ứng được yêu cầu cả về business lẫn technical, thì đây chính là lúc đem lên môi trường production. Giai đoạn này được gọi là model serving. </div>

<img src="model-serving-meme.jpeg" alt="Model serving meme" width="500" height="500" />

<br />

<p>Có nhiều hình thức để serve một model, và cũng có nhiều tool/framework hỗ trợ chúng ta làm điều này.</p>
<h4 id="1-Cac-hinh-thuc-serving"><a href="#1-Cac-hinh-thuc-serving" class="headerlink" title="1. Các hình thức serving"></a>1. Các hình thức serving</h4><ul>
<li><strong>Offline serving (batch inference)</strong>: model dự đoán trên cả tập dữ liệu test, và lưu kết quả vào 1 database hoặc storage.</li>
<li><strong>Model as a service:</strong> đóng gói model thành một service và cung cấp API endpoint cho user. User sẽ tạo POST/GET request tới endpoint này để trigger quá trình model inference và nhận về kết quả.</li>
<li><strong>Edge deployment:</strong> chuyển đổi model thành định dạng phù hợp (ví dụ ONNX) để deploy trên các thiết bị edge (ví dụ: browser, Raspberry Pi, Nvidia Jetson Nano, và Google Coral, …)</li>
</ul>
<h4 id="2-Khi-nao-thi-dung-hinh-thuc-serving-nao"><a href="#2-Khi-nao-thi-dung-hinh-thuc-serving-nao" class="headerlink" title="2. Khi nào thì dùng hình thức serving nào"></a>2. Khi nào thì dùng hình thức serving nào</h4><img src="model-serving-comparision.png" alt="Model serving comparisions" width="900" height="300">

<h4 id="3-BentoML"><a href="#3-BentoML" class="headerlink" title="3. BentoML"></a>3. BentoML</h4><p>BentoML là một framework hỗ trợ đóng gói và deploy model trên nhiều nền tảng khác nhau, ví dụ:</p>
<ul>
<li>Serverless Compute Services như AWS Lambda và Google Cloud Run</li>
<li>Compute Engine như Amazon EC2</li>
<li>AI Platform như Amazon SageMaker, VertexAI</li>
<li>Kubernetes Cluster như Kubeflow</li>
</ul>
<p>Bên cạnh đó BentoML cũng cung cấp CLI, Python API và Web UI để quản lý các model trên production.</p>
<img src="yatai.png" alt="Yatai Web UI" width="700" height="300" />
<figcaption align="center" font-size="8px"><i>Source: https://github.com/bentoml/BentoML</i></figcaption>

<h4 id="4-Quickstart"><a href="#4-Quickstart" class="headerlink" title="4. Quickstart"></a>4. Quickstart</h4><p>Cài đặt BentoML khá đơn giản, chỉ cần chạy command</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install bentoml&#x3D;&#x3D;0.13.1</span><br></pre></td></tr></table></figure>
<p>Quickstart này sẽ hướng dẫn mọi người cách serve một model SVM đơn giản (train trên dữ liệu Iris).<br>Project structure của chúng ta sẽ như sau:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">example&#x2F;</span><br><span class="line">├── bento_service.py      # BentoService definition</span><br><span class="line">├── train.py              # For training and packaging</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure>
<p>File <strong>bento_service.py</strong> dùng để định nghĩa BentoService, bao gồm thông tin về model, package dependencies và code để predict</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bentoml <span class="keyword">import</span> env, artifacts, api, BentoService</span><br><span class="line"><span class="keyword">from</span> bentoml.adapters <span class="keyword">import</span> DataframeInput</span><br><span class="line"><span class="keyword">from</span> bentoml.frameworks.sklearn <span class="keyword">import</span> SklearnModelArtifact</span><br><span class="line"></span><br><span class="line"><span class="meta">@env(<span class="params">infer_pip_packages=<span class="literal">True</span></span>) </span><span class="comment"># automatically infer necessary pip packages</span></span><br><span class="line"><span class="meta">@artifacts(<span class="params">[SklearnModelArtifact(<span class="params"><span class="string">&#x27;model&#x27;</span></span>)]</span>) </span><span class="comment"># since our model is scikit-learn based</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IrisClassifier</span>(<span class="params">BentoService</span>):</span></span><br><span class="line"><span class="meta">    @api(<span class="params"><span class="built_in">input</span>=DataframeInput(<span class="params"></span>), batch=<span class="literal">True</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">predict</span>(<span class="params">self, df: pd.DataFrame</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.artifacts.model.predict(df)</span><br></pre></td></tr></table></figure>
<p>File <strong>train.py</strong> sẽ dùng để training model, và đóng gói model thành 1 BentoService bundle</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bento_service <span class="keyword">import</span> IrisClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> svm</span><br><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load training data</span></span><br><span class="line">iris = datasets.load_iris()</span><br><span class="line">X, y = iris.data, iris.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># Model Training</span></span><br><span class="line">clf = svm.SVC(gamma=<span class="string">&#x27;scale&#x27;</span>)</span><br><span class="line">clf.fit(X, y)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a iris classifier service instance</span></span><br><span class="line">iris_classifier_service = IrisClassifier()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pack the newly trained model artifact</span></span><br><span class="line">iris_classifier_service.pack(<span class="string">&#x27;model&#x27;</span>, clf)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save the prediction service to disk for model serving</span></span><br><span class="line">saved_path = iris_classifier_service.save(version=<span class="string">&quot;0.0.1&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Sau khi run file này, thì các bác sẽ thấy log ở console tương tự như sau:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BentoService bundle &#39;IrisClassifier:0.0.1&#39; saved to: &#x2F;Users&#x2F;yourusername&#x2F;bentoml&#x2F;repository&#x2F;IrisClassifier&#x2F;0.0.1</span><br></pre></td></tr></table></figure>
<p>Dưới đây là cấu trúc thư mục của BentoService bundle. Mọi người có thể thấy đoạn code snippet của chúng ta đã được bundle thành rất nhiều file khác để sẵn sàng cho việc đóng gói và deploy mà không cần quá nhiều kiến thức về Docker hay DevOps.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">|____docs.json</span><br><span class="line">|____requirements.txt</span><br><span class="line">|____environment.yml</span><br><span class="line">|____bentoml.yml</span><br><span class="line">|____Dockerfile</span><br><span class="line">|____IrisClassifier</span><br><span class="line">| |____artifacts</span><br><span class="line">| | |______init__.py</span><br><span class="line">| | |____model.pkl</span><br><span class="line">| |____bentoml.yml</span><br><span class="line">| |______init__.py</span><br><span class="line">| |____bento_service.py</span><br><span class="line">| |____zipimports</span><br><span class="line">|____python_version</span><br><span class="line">|____MANIFEST.in</span><br><span class="line">|____README.md</span><br><span class="line">|____setup.py</span><br><span class="line">|____docker-entrypoint.sh</span><br><span class="line">|____bentoml-init.sh</span><br></pre></td></tr></table></figure>
<p>Bây giờ để start API server chúng ta chỉ cần sử dụng đường dẫn tới bundle vừa nãy như sau:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bentoml serve /Users/yourusername/bentoml/repository/IrisClassifier/0.0.1 --port 5005</span><br></pre></td></tr></table></figure>
<p>và sẽ thấy ứng dụng đang run ở port 5005</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ bentoml serve /Users/quandv6/bentoml/repository/IrisClassifier/0.0.1 --port 5005</span><br><span class="line">[2022-01-03 18:25:40,967] INFO - Starting BentoML API proxy <span class="keyword">in</span> development mode..</span><br><span class="line">[2022-01-03 18:25:41,078] INFO - Micro batch enabled <span class="keyword">for</span> API `predict` max-latency: 20000 max-batch-size 4000</span><br><span class="line">[2022-01-03 18:25:41,078] INFO - Your system nofile <span class="built_in">limit</span> is 10496, <span class="built_in">which</span> means each instance of microbatch service is able to hold this number of connections at same time. You can increase the number of file descriptors <span class="keyword">for</span> the server process, or launch more microbatch instances to accept more concurrent connection.</span><br><span class="line">======== Running on http://0.0.0.0:5005 ========</span><br><span class="line">(Press CTRL+C to quit)</span><br><span class="line">[2022-01-03 18:25:41,379] INFO - Starting BentoML API server <span class="keyword">in</span> development mode..</span><br><span class="line"> * Serving Flask app <span class="string">&#x27;IrisClassifier&#x27;</span> (lazy loading)</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it <span class="keyword">in</span> a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: off</span><br><span class="line"> * Running on http://127.0.0.1:65425/ (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure>
<p>Thử tạo một request tới API thôi nào!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl -i \                                                                                                    </span><br><span class="line">    --header <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">    --request POST \</span><br><span class="line">    --data <span class="string">&#x27;[[5.1, 3.5, 1.4, 0.2]]&#x27;</span> \</span><br><span class="line">    http://localhost:5005/predict</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">X-Request-Id: 581e7229-ac6d-488a-a672-8b425210ed4e</span><br><span class="line">Content-Length: 3</span><br><span class="line">Date: Mon, 03 Jan 2022 11:16:51 GMT</span><br><span class="line">Server: Python/3.8 aiohttp/3.8.1</span><br><span class="line"></span><br><span class="line">[0]</span><br></pre></td></tr></table></figure>
<h4 id="5-Tai-lieu-tham-khao"><a href="#5-Tai-lieu-tham-khao" class="headerlink" title="5. Tài liệu tham khảo"></a>5. Tài liệu tham khảo</h4><ol>
<li><a target="_blank" rel="noopener" href="https://spell.ml/blog/mlops-concepts-model-serving-X385lREAACcAAGzS">https://spell.ml/blog/mlops-concepts-model-serving-X385lREAACcAAGzS</a></li>
<li><a target="_blank" rel="noopener" href="https://mercari.github.io/ml-system-design-pattern">https://mercari.github.io/ml-system-design-pattern</a></li>
<li><a target="_blank" rel="noopener" href="https://neptune.ai/blog/ml-model-serving-best-tools">https://neptune.ai/blog/ml-model-serving-best-tools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bentoml/BentoML">https://github.com/bentoml/BentoML</a></li>
</ol>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2021/08/22/test-in-ml/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2021-10-30 10:09:30
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="Tags"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/model-serving/" title="model serving">
                        <b>#</b> model serving
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div class="post-catalog" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Cac-hinh-thuc-serving"><span class="toc-text">1. Các hình thức serving</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Khi-nao-thi-dung-hinh-thuc-serving-nao"><span class="toc-text">2. Khi nào thì dùng hình thức serving nào</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-BentoML"><span class="toc-text">3. BentoML</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-Quickstart"><span class="toc-text">4. Quickstart</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-Tai-lieu-tham-khao"><span class="toc-text">5. Tài liệu tham khảo</span></a></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        
  <div id="disqus_thread"></div>
  <script>

  /**
  *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
  /*
  var disqus_config = function () {
  this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');
  s.src = 'https://quan-dang.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>






      </div>
    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="facebook" href="">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" href="">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="wechat" href="">
            <i class="iconfont icon-wechat"></i>
          </a>
        </li>
      
        <li>
          <a title="weibo" href="">
            <i class="iconfont icon-weibo"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © Oranges 2020</a>
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
